<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pj.springboot.docs.srvc.VocService">
	
	<!-- 고객응대 총 개수 조회-->
	<select id="getTotalCount" resultType="int" 
	parameterType="com.pj.springboot.voc.dto.VocDTO">
		SELECT COUNT(*)
		FROM   DOC_ARCH DA  
			   INNER JOIN MYPAGE MP
			           ON DA.REG_USER_ID = MP.USERID
			   LEFT OUTER JOIN ATCH_FILE AF
			           ON DA.ARCH_ID = AF.POST_ID
		WHERE  DA.ARCH_TYPE = '10'
		<if test="srchType != '' and srchType != null and srchType != 'ALL' and srchWord != '' and srchWord != null">
			AND DA.${srchType} LIKE '%'||#{srchWord}||'%'
		</if>
		<if test="srchType == 'ALL' and srchWord != null and srchWord != ''">
		    AND (
		      DA.ARCH_TITLE LIKE '%' || TRIM(#{srchWord}) || '%'
		      OR DA.ARCH_CTNT LIKE '%' || TRIM(#{srchWord}) || '%'
		      OR DA.REG_USER_ID LIKE '%' || TRIM(#{srchWord}) || '%'
		    )
		</if>
	</select>
	
	<!-- 고객응대 다건 조회 -->
	<select id="selectVocList" 
	resultType="com.pj.springboot.voc.dto.VocDTO" 
	parameterType="com.pj.springboot.voc.dto.VocDTO">
		SELECT * FROM (
			SELECT Tb.*, rownum rNum FROM (
				SELECT DA.ARCH_ID,
				       DA.ARCH_TYPE,
				       DA.ARCH_TITLE,
				       DA.ARCH_CTNT,
				       DA.REG_DT,
				       DA.REG_USER_ID,
				       MP.DEPARTMENT,
				       AF.FILE_ID,
		      		   SUBSTR(PHYS_PATH, INSTR(PHYS_PATH, '+++') + 3) AS FILE_NM
				FROM   DOC_ARCH DA  
					   INNER JOIN MYPAGE MP
					           ON DA.REG_USER_ID = MP.USERID
					   LEFT OUTER JOIN ATCH_FILE AF
					           ON DA.ARCH_ID = AF.POST_ID
				WHERE  DA.ARCH_TYPE = '10'
				<if test="srchType != '' and srchType != null and srchType != 'ALL' and srchWord != '' and srchWord != null">
					AND DA.${srchType} LIKE '%'||#{srchWord}||'%'
				</if>
				<if test="srchType == 'ALL' and srchWord != null and srchWord != ''">
			        AND (
			          DA.ARCH_TITLE LIKE '%' || TRIM(#{srchWord}) || '%'
			          OR DA.ARCH_CTNT LIKE '%' || TRIM(#{srchWord}) || '%'
			          OR DA.REG_USER_ID LIKE '%' || TRIM(#{srchWord}) || '%'
			        )
				</if>
				ORDER BY DA.REG_DT DESC, DA.REG_TM DESC
			) Tb
		)
		WHERE rNum<![CDATA[>=]]>#{start} AND rNum<![CDATA[<=]]>#{end}
	</select>

	<!-- 고객응대 단건 조회 -->	
	<select id="selectVoc" resultType="com.pj.springboot.voc.dto.VocDTO"
	parameterType="com.pj.springboot.voc.dto.VocDTO">
		SELECT DA.ARCH_ID,
		       DA.ARCH_TYPE,
		       DA.ARCH_TITLE,
		       DA.ARCH_CTNT,
		       DA.REG_DT,
		       DA.REG_USER_ID,
		       MP.DEPARTMENT,
		       AF.FILE_ID,
		       SUBSTR(PHYS_PATH, INSTR(PHYS_PATH, '+++') + 3) AS FILE_NM
		FROM   DOC_ARCH DA  
			   INNER JOIN MYPAGE MP
			           ON DA.REG_USER_ID = MP.USERID
			   LEFT OUTER JOIN ATCH_FILE AF
			           ON DA.ARCH_ID = AF.POST_ID
		WHERE  DA.ARCH_TYPE = '10'
		AND    DA.ARCH_ID = ${archId}
	</select>

	<!-- 고객응대 max조회 -->
	<select id="getMaxArchId" resultType="int">
		SELECT MAX(ARCH_ID) 
		FROM   DOC_ARCH DA
		WHERE  DA.ARCH_TYPE = '10'
	</select>

	<!-- 고객응대 등록 -->
	<insert id="insertVoc" parameterType="com.pj.springboot.voc.dto.VocDTO">
	    <selectKey keyProperty="archId" resultType="int" order="BEFORE">
	      SELECT NVL(MAX(ARCH_ID), 0) + 1 AS ARCH_ID FROM DOC_ARCH
	    </selectKey>
	    INSERT INTO DOC_ARCH (
	        ARCH_ID,ARCH_TYPE, ARCH_TITLE, ARCH_CTNT,
	        UDT_DT, UDT_TM, UDT_USER_ID,
	        REG_DT, REG_TM, REG_USER_ID	      
		)
		VALUES (
			#{archId, jdbcType=NUMERIC},
			#{archType, jdbcType=CHAR},
			#{archTitle, jdbcType=VARCHAR},
			#{archCtnt, jdbcType=VARCHAR},
         	TO_CHAR(SYSDATE, 'YYYYMMDD'),
         	TO_CHAR(SYSDATE, 'HH24MISS'),
			#{regUserId, jdbcType=VARCHAR},
         	TO_CHAR(SYSDATE, 'YYYYMMDD'),
         	TO_CHAR(SYSDATE, 'HH24MISS'),
			#{regUserId, jdbcType=VARCHAR}
		)
	</insert>
	
	<!-- 고객응대 수정 -->
   <update id="updateVoc" parameterType="com.pj.springboot.voc.dto.VocDTO">
		UPDATE DOC_ARCH SET
			ARCH_TITLE = #{archTitle},
			ARCH_CTNT  = #{archCtnt},
			UDT_DT     = TO_CHAR(SYSDATE, 'YYYYMMDD'),
			UDT_TM     = TO_CHAR(SYSDATE, 'HH24MISS'),
			UDT_USER_ID=#{regUserId}
		WHERE ARCH_ID = #{archId}
   </update>
	
	<!-- 고객응대 삭제 -->
	<delete id="deleteVoc" parameterType="int">
	    DELETE FROM DOC_ARCH 
	    WHERE ARCH_ID = #{archId}
	</delete>
        
    <!-- 첨부파일 조회 -->
    <select id ="selectAtchFile" parameterType="int" resultType="com.pj.springboot.docs.dto.AtchFileDTO">
    	SELECT FILE_ID,
    		   POST_ID,
    		   LOGI_PATH,
    		   PHYS_PATH,
    		   REG_USER_ID
		FROM   ATCH_FILE
		WHERE  FILE_ID = #{fileId}
    </select>
    
	<!-- 첨부파일 등록 -->
	<insert id="insertAtchFile"
	parameterType="com.pj.springboot.docs.dto.AtchFileDTO">
	  <selectKey keyProperty="fileId" resultType="int" order="BEFORE">
	    SELECT NVL(MAX(FILE_ID), 0) + 1 AS FILE_ID FROM ATCH_FILE
	  </selectKey>
	    INSERT INTO ATCH_FILE (
	    	FILE_ID,
	        POST_ID,
	        LOGI_PATH,
	        PHYS_PATH,
	        UDT_DT,
	        UDT_TM,
	        UDT_USER_ID,
	        REG_DT,
	        REG_TM,
	        REG_USER_ID
	    ) VALUES (
	    	#{fileId, jdbcType=NUMERIC},
	        #{archId  , jdbcType=NUMERIC},
	        #{logiPath, jdbcType=VARCHAR},
	        #{physPath , jdbcType=VARCHAR},
         	TO_CHAR(SYSDATE, 'YYYYMMDD'),
         	TO_CHAR(SYSDATE, 'HH24MISS'),
	        #{regUserId, jdbcType=CHAR},
         	TO_CHAR(SYSDATE, 'YYYYMMDD'),
         	TO_CHAR(SYSDATE, 'HH24MISS'),
	        #{regUserId, jdbcType=CHAR}
	    )
    </insert>
    
	<!-- 첨부파일 삭제 -->
	<delete id="deleteAtchFile"
	parameterType="int">
    	DELETE FROM ATCH_FILE 
    	WHERE POST_ID = ${archId}
    </delete>
    
    <!-- 사용자 정보 조회 -->
    <select id="selectUserInfo" 
    parameterType="String"
    resultType="com.pj.springboot.voc.dto.VocDTO">
    	SELECT M.USERID AS REG_USER_ID,
    	       M.DEPARTMENT
    	FROM   MYPAGE M
    	WHERE  M.USERID = #{param1}
    </select> 
</mapper>